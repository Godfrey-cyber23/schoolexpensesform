<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Entry Form - Action for Children Zambia</title>
    <style>
        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --secondary: #f5f6fa;
            --dark: #2c3e50;
            --text-muted: #666;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --border: #dfe6e9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary);
            margin: 0;
            padding: 20px; /* Reduced from 20px */
            min-height: 100vh; /* Ensure full height on mobile */
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
            font-size: 16px; /* Base readable size */
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            width: 100%; /* Ensure responsive width */
        }

        /* Header & Branding */
        .org-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .org-name {
            font-size: 1.8rem; /* Slightly smaller on mobile */
            color: var(--primary);
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .org-tagline {
            font-size: 0.95rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 8px;
            display: block;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 16px;
            border: 1px solid var(--primary);
            border-radius: 50px;
            transition: all 0.2s ease;
            background: white;
        }

        .back-link:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(74, 144, 226, 0.3);
        }

        /* Card Styling */
        .form-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Prevent horizontal scroll */
            margin-bottom: 40px;
            width: 100%; /* Responsive width */
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 15px;
        }

        .form-header h2 { margin: 0; font-size: 1.5rem; }
        .form-header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }
        
        .header-total {
            text-align: right;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        .header-total small { display: block; font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-total div { font-size: 1.4rem; font-weight: 700; line-height: 1.2; color: white; }

        .form-body { padding: 30px; }

        /* Sections */
        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-top: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .section-title:first-child { margin-top: 0; }

        .section-total {
            font-size: 0.85rem;
            color: var(--primary);
            background: rgba(74, 144, 226, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
        }

        /* Inputs */
        .student-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        .form-group { margin-bottom: 15px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .helper-text {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            margin-top: -5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem; /* Improved readability */
            transition: all 0.2s;
            background-color: #fcfcfc;
            /* Mobile Optimization: Larger touch target */
            min-height: 44px; 
        }

        input:focus, select:focus, textarea:focus {
            background-color: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* Category Toggles */
        .category-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 25px;
        }

        .cat-chip input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }

        .chip-label {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #555;
            user-select: none;
        }

        .cat-chip input:checked + .chip-label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

        /* Dynamic Sections */
        .category-section {
            display: none;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .category-section.visible {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Items Table */
        .items-table {
            width: 100%;
            border-collapse: separate;
            /* Reduced spacing to save vertical space on mobile */
            border-spacing: 0 4px; 
            margin-top: 15px;
        }

        .items-table th {
            text-align: left;
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            padding: 0 10px 8px 8px 10px; /* Less padding for mobile */
            font-weight: 600;
        }

        .items-table td {
            background: white;
            padding: 8px 15px; /* Reduced padding */
            vertical-align: middle;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        
        .items-table td:first-child {
            border-top: none; /* No top border on first row */
        }

        .item-input {
            width: 100%;
            border: none;
            font-size: 0.95rem;
            background: transparent;
            /* Reduced touch target for table inputs */
            min-height: 38px; 
        }
        .item-input:focus { box-shadow: none; background: #f9f9f9; }

        .btn-remove {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .btn-remove:hover { color: var(--danger); }

        .btn-add-item {
            background: white;
            color: var(--primary);
            border: 1px dashed var(--primary);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            /* Larger touch target */
            min-height: 44px;
        }
        .btn-add-item:hover { background: rgba(74, 144, 226, 0.05); }

        /* Totals */
        .grand-total-section {
            margin-top: 30px;
            background: #2c3e50;
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row; /* Keep row on desktop */
        }

        .grand-total-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .grand-total-value { font-size: 2rem; font-weight: 700; line-height: 1; color: #fff; }

        /* Actions */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-direction: row;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            flex: 1;
            min-height: 44px; /* Mobile touch target */
        }

        .btn-save {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.2);
        }
        .btn-save:hover { background: #27ae60; transform: translateY(-2px); }

        .btn-cancel {
            background: white;
            border: 1px solid #ddd;
            color: #555;
        }
        .btn-cancel:hover { background: #f8f8f8; border-color: #ccc; }

        /* Utilities */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: none;
            animation: fadeIn 0.3s;
        }
        .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        #loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px; height: 50px;
            margin: 0 auto 15px;
            animation: spin 1s linear infinite;
        }
        
        .loading-text { margin-top: 15px; font-weight: 600; color: var(--primary); font-size: 1.1rem; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* =========================================
           RESPONSIVE BREAKPOINTS (MOBILE)
           ========================================= */
        @media (max-width: 600px) {
            /* 1. Body & Container */
            body { padding: 10px; font-size: 14px; } /* Less padding, slightly smaller font */

            .form-header { 
                flex-direction: column; 
                align-items: flex-start; 
                text-align: left; 
                padding: 20px; 
                gap: 10px;
            }
            .header-total { 
                width: 100%; 
                text-align: left; 
                margin-top: 10px; 
            }
            
            /* 2. Grids */
            .student-details-grid {
                grid-template-columns: 1fr; /* Stack columns */
                gap: 10px;
            }

            .category-selector {
                gap: 8px; /* Tighter gap */
            }
            
            .chip-label {
                padding: 8px 14px; /* Smaller text/padding */
                font-size: 0.85rem;
                flex-grow: 1; /* Fill available space */
                justify-content: center;
            }

            /* 3. Buttons */
            .button-group {
                flex-direction: column; /* Stack buttons vertically */
                gap: 10px;
            }
            button { width: 100%; /* Full width buttons */ }

            /* 4. Grand Total */
            .grand-total-section {
                flex-direction: column; /* Stack text */
                align-items: flex-start;
                text-align: left;
                gap: 5px;
            }
            .grand-total-value { font-size: 1.8rem; }
            
            /* 5. Tables & Inputs */
            /* Make item inputs stack on very small screens if table is too cramped */
            /* Note: We keep table structure for alignment, but ensure inputs fit */
            .item-input { 
                min-height: 40px; /* Ensure tap area */
            }
            .items-table th { 
                padding: 8px 4px; 
                font-size: 0.75rem; /* Smaller headers */
            }
            .items-table td { 
                padding: 10px 5px; /* Adjust padding */
            }
        }
        
        @media (max-width: 400px) {
            /* Very small phones */
            .section-title { font-size: 0.85rem; }
            /* If table is too wide, consider hiding "Price" header on mobile */
            /* .items-table th:nth-child(3) { display: none; } */
        }
    </style>
</head>

<body>

    <div class="container">
        <a href="dashboard.html" class="back-link">← Back to Dashboard</a>

        <div class="org-header">
            <h1 class="org-name">Action for Children Zambia</h1>
            <span class="org-tagline">Empowering Zambian Children Through Education</span>
        </div>

        <div class="form-card">
            <div class="form-header">
                <div style="flex: 1;">
                    <h2 id="pageTitle">Add New Expense Record</h2>
                    <p>Select categories and enter specific line items</p>
                </div>
                <div class="header-total">
                    <small>Grand Total</small>
                    <div id="headerTotal">0.00</div>
                </div>
            </div>

            <div id="successMessage" class="message success-message"></div>
            <div id="errorMessage" class="message error-message"></div>

            <form id="expenseForm" class="form-body">

                <!-- 1. Student Context -->
                <div class="section-title">Student Details</div>
                <div class="student-details-grid">
                    <div class="form-group">
                        <label>Student Name</label>
                        <select id="student" required>
                            <option value="">Select Student...</option>
                            <option value="Misheck Kombe">Misheck Kombe</option>
                            <option value="Gift Chanda">Gift Chanda</option>
                            <option value="Mundia Munalula">Mundia Munalula</option>
                            <option value="Chama Mbao">Chama Mbao</option>
                            <option value="Boyd Mulenga">Boyd Mulenga</option>
                            <option value="Richard Mulenga">Richard Mulenga</option>
                            <option value="David Mwansa">David Mwansa</option>
                            <option value="Theresa Mwashi">Theresa Mwashi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Term</label>
                        <select id="term" required>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                            <option value="Semester 1">Semester 1</option>
                            <option value="Semester 2">Semester 2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="year" value="2026" required min="2026" max="2100">
                    </div>
                    <div class="form-group">
                        <label>Expense Date</label>
                        <input type="date" id="expense_date" required>
                    </div>
                </div>

                <!-- 2. Category Selector -->
                <div class="section-title">Select Expense Categories</div>
                <div class="category-selector">
                    <div class="cat-chip">
                        <input type="checkbox" id="check-tuition" onchange="toggleCategorySection('tuition', this.checked)">
                        <label for="check-tuition" class="chip-label">Tuition</label>
                    </div>
                    <div class="cat-chip">
                        <input type="checkbox" id="check-food" onchange="toggleCategorySection('food', this.checked)">
                        <label for="check-food" class="chip-label">Food</label>
                    </div>
                    <div class="cat-chip">
                        <input type="checkbox" id="check-transport" onchange="toggleCategorySection('transport', this.checked)">
                        <label for="check-transport" class="chip-label">Transport</label>
                    </div>
                    <div class="cat-chip">
                        <input type="checkbox" id="check-materials" onchange="toggleCategorySection('materials', this.checked)">
                        <label for="check-materials" class="chip-label">Materials</label>
                    </div>
                    <div class="cat-chip">
                        <input type="checkbox" id="check-hygiene" onchange="toggleCategorySection('hygiene', this.checked)">
                        <label for="check-hygiene" class="chip-label">Hygiene</label>
                    </div>
                    <div class="cat-chip">
                        <input type="checkbox" id="check-other" onchange="toggleCategorySection('other', this.checked)">
                        <label for="check-other" class="chip-label">Other</label>
                    </div>
                </div>

                <!-- 3. Category Sections (Dynamic Items) -->
                <!-- Tuition -->
                <div id="section-tuition" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Tuition Details</span>
                        <span class="section-total">Total: <span id="tuition-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Description</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tuition-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('tuition')">+ Add Tuition Item</button>
                </div>

                <!-- Food -->
                <div id="section-food" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Food Details</span>
                        <span class="section-total">Total: <span id="food-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Item Name</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="food-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('food')">+ Add Food Item</button>
                </div>

                <!-- Transport -->
                <div id="section-transport" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Transport Details</span>
                        <span class="section-total">Total: <span id="transport-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Description</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="transport-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('transport')">+ Add Transport Item</button>
                </div>

                <!-- Materials -->
                <div id="section-materials" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Materials Details</span>
                        <span class="section-total">Total: <span id="materials-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Item Name</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="materials-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('materials')">+ Add Materials Item</button>
                </div>

                <!-- Hygiene -->
                <div id="section-hygiene" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Hygiene Details</span>
                        <span class="section-total">Total: <span id="hygiene-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Item Name</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="hygiene-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('hygiene')">+ Add Hygiene Item</button>
                </div>

                <!-- Other -->
                <div id="section-other" class="category-section">
                    <div class="section-title" style="margin-top:0; border:none; padding-bottom:0;">
                        <span>Other Details</span>
                        <span class="section-total">Total: <span id="other-total">0.00</span></span>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="45%">Description</th>
                                <th width="20%">Qty</th>
                                <th width="25%">Price (ZMW)</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="other-items"></tbody>
                    </table>
                    <button type="button" class="btn-add-item" onclick="addItemRow('other')">+ Add Other Item</button>
                </div>

                <!-- 4. Notes & Totals -->
                <div class="section-title">Additional Information</div>
                <div class="form-group">
                    <label>Notes / Reference</label>
                    <small class="helper-text">Receipt number, bank reference, or payment method details</small>
                    <textarea id="notes" rows="3" placeholder="E.g. Airtel Money Ref: 12345..."></textarea>
                </div>

                <div class="grand-total-section">
                    <div>
                        <div class="grand-total-label">Grand Total Amount (ZMW)</div>
                        <div class="grand-total-value" id="grandTotal">0.00</div>
                    </div>
                    <!-- Simple visual representation of ZMW flag color could go here -->
                </div>

                <div class="button-group">
                    <button type="button" class="btn-cancel" onclick="goBack()">Cancel</button>
                    <button type="submit" class="btn-save" id="saveBtn">Save Record</button>
                </div>

            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

        <script>
        // --- CONFIGURATION ---
        // NOTE: Ensure this URL matches your deployed Google Apps Script Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzEEeuwtZm-qGOmKLza3IfdVieYurAH14xgp3Q0lUPwUpvyz2rIHUlkC48sCc2FUK9i/exec";
        const DASHBOARD_URL = "dashboard.html";

        let editingId = null;
        const categories = ['tuition', 'food', 'transport', 'materials', 'hygiene', 'other'];
        
        // Suggestion lists for autocomplete
        const itemSuggestions = {
            tuition: ['School Fees', 'Exam Fees', 'Library Fees', 'Sports Fees', 'ICT Fees'],
            food: ['Breakfast Meal', 'Lunch Meal', 'Groceries - Rice', 'Groceries - Vegetables', 'Snacks', 'Mineral Water'],
            transport: ['Bus Fare - Return', 'Taxi - Local', 'Bicycle Repair', 'Fuel', 'Airport Transfer'],
            materials: ['Exercise Books (A4)', 'Math Set', 'Text Books', 'School Uniform', 'School Shoes', 'Bag of Cement'],
            hygiene: ['Bar Soap', 'Washing Powder', 'Toothpaste', 'Body Lotion', 'Sanitary Pads', 'Bleach'],
            other: ['Medical Checkup', 'Club Registration', 'Emergency Contribution']
        };

        // --- INIT ---
        window.onload = function () {
    document.getElementById('expense_date').valueAsDate = new Date();
    
    // Set the year input to 2026
    document.getElementById('year').value = 2026;
    
    checkForEditMode();
    setupEventListeners();
};

        // --- UI HELPERS ---
        function showMessage(msg, type = 'success') {
            const el = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function hideMessages() {
            document.querySelectorAll('.message').forEach(el => el.style.display = 'none');
        }

        // --- CATEGORY & ITEM LOGIC ---
        function toggleCategorySection(category, isChecked) {
            const section = document.getElementById(`section-${category}`);
            if (isChecked) {
                section.classList.add('visible');
                const tbody = document.getElementById(`${category}-items`);
                if (tbody.children.length === 0) addItemRow(category);
            } else {
                section.classList.remove('visible');
                document.getElementById(`${category}-items`).innerHTML = '';
            }
            updateGrandTotal();
        }

        function addItemRow(category) {
            const tbody = document.getElementById(`${category}-items`);
            const rowId = Date.now() + Math.random().toString(16).slice(2);
            
            const tr = document.createElement('tr');
            tr.dataset.id = rowId;
            
            // Suggestions Datalist
            const listId = `list-${category}-${rowId}`;
            const datalist = document.createElement('datalist');
            datalist.id = listId;
            itemSuggestions[category].forEach(text => {
                const opt = document.createElement('option');
                opt.value = text;
                datalist.appendChild(opt);
            });
            document.body.appendChild(datalist);

            tr.innerHTML = `
                <td><input type="text" class="item-input item-desc" placeholder="Item name" list="${listId}"></td>
                <td><input type="number" class="item-input item-qty" value="1" min="0" step="1" oninput="calculateItemTotal(this)"></td>
                <td><input type="number" class="item-input item-price" placeholder="0.00" min="0" step="0.01" oninput="calculateItemTotal(this)"></td>
                <td style="text-align:center;"><button type="button" class="btn-remove" onclick="removeItemRow('${category}', '${rowId}')" title="Remove">×</button></td>
            `;
            
            tbody.appendChild(tr);
            // Focus description
            tr.querySelector('.item-desc').focus();
        }

        function removeItemRow(category, rowId) {
            const row = document.querySelector(`#${category}-items tr[data-id="${rowId}"]`);
            if(row) {
                row.remove();
                const list = document.getElementById(`list-${category}-${rowId}`);
                if(list) list.remove();
                updateCategoryTotal(category);
            }
        }

        function calculateItemTotal(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            row.dataset.total = qty * price;
            
            const section = row.closest('.category-section');
            if(section) {
                const cat = section.id.replace('section-', '');
                updateCategoryTotal(cat);
            }
        }

        function updateCategoryTotal(category) {
            const rows = document.querySelectorAll(`#${category}-items tr`);
            let total = 0;
            rows.forEach(r => total += parseFloat(r.dataset.total) || 0);
            
            document.getElementById(`${category}-total`).textContent = formatCurrency(total);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grand = 0;
            categories.forEach(cat => {
                if(document.getElementById(`check-${cat}`).checked) {
                    const rows = document.querySelectorAll(`#${cat}-items tr`);
                    rows.forEach(r => grand += parseFloat(r.dataset.total) || 0);
                }
            });
            const formatted = formatCurrency(grand);
            document.getElementById('grandTotal').textContent = formatted;
            document.getElementById('headerTotal').textContent = formatted;
        }

        function formatCurrency(num) {
            return parseFloat(num || 0).toLocaleString('en-ZM', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- DATA HANDLING ---
        function gatherFormData() {
            const data = {
                student: document.getElementById('student').value,
                term: document.getElementById('term').value,
                year: parseInt(document.getElementById('year').value),
                expense_date: document.getElementById('expense_date').value,
                notes: document.getElementById('notes').value.trim()
            };

            // Nested Items Structure
            const items = {};
            let hasItems = false;

            categories.forEach(cat => {
                if(document.getElementById(`check-${cat}`).checked) {
                    const catItems = [];
                    const rows = document.querySelectorAll(`#${cat}-items tr`);
                    
                    rows.forEach(row => {
                        const descInput = row.querySelector('.item-desc'); // FIX: Match HTML class
                        const qtyInput = row.querySelector('.item-qty');   // FIX: Match HTML class
                        const priceInput = row.querySelector('.item-price'); 

                        const description = descInput ? descInput.value.trim() : '';
                        const quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                        const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        const total = quantity * price;

                        if(description && total > 0) {
                            catItems.push({ description: description, quantity: quantity, price: price, total: total });
                        }
                    });

                    if(catItems.length > 0) {
                        items[cat] = catItems;
                        hasItems = true;
                    }
                }
            });

            if(!hasItems) return null;
            data.items = items;
            return data;
        }

        // --- 5. FORM SUBMISSION ---
        document.getElementById("expenseForm").addEventListener("submit", async e => {
            e.preventDefault();

            // Clear any existing messages
            hideMessages();

            // Validate student selection
            const student = document.getElementById("student").value;
            const term = document.getElementById("term").value;
            const year = document.getElementById("year").value;

            if (!student) {
                showMessage("Please select a student.", 'error');
                document.getElementById("student").focus();
                return;
            }

            // Validate at least one category is selected
            const anyChecked = Array.from(document.querySelectorAll('.category-selector input[type="checkbox"]'))
                .some(cb => cb.checked);

            if (!anyChecked) {
                showMessage("Please select at least one expense category.", 'error');
                return;
            }

            // Validate each selected category has at least one valid item
            let hasValidItems = false;
            categories.forEach(category => {
                const checkbox = document.getElementById(`check-${category}`);
                if (checkbox.checked) {
                    const itemsTable = document.getElementById(`${category}-items`);
                    const rows = itemsTable.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        // FIX: Use correct class names matching HTML (item-desc, item-qty)
                        const descInput = row.querySelector('.item-desc');
                        const priceInput = row.querySelector('.item-price');

                        const description = descInput ? descInput.value.trim() : '';
                        const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        
                        if (description && price > 0) {
                            hasValidItems = true;
                        }
                    });
                }
            });

            if (!hasValidItems) {
                showMessage("Please enter at least one item with description and amount greater than 0.", 'error');
                return;
            }

            // ===========================================
            // NEW: CHECK DUPLICATES ON FRONTEND
            // ===========================================
            // We check existing data before sending to backend for better UX
            // If we are editing, we skip this check
            if (!editingId) {
                document.getElementById('loading').style.display = 'flex'; // Show loading while checking
                try {
                    const checkRes = await fetch(`${API_URL}?action=read`);
                    const checkJson = await checkRes.json();
                    const existingRecords = checkJson.data || [];

                    // Check if Student/Term/Year combination already exists
                    const isDuplicate = existingRecords.some(r => 
                        r.student === student && 
                        r.term === term && 
                        String(r.year) === String(year)
                    );

                    if (isDuplicate) {
                        document.getElementById('loading').style.display = 'none'; // Hide loading
                        showMessage(`Duplicate Record: ${student} already has a record for ${term} ${year}.`, 'error');
                        alert(`This student already has a record for ${term}, ${year}.\n\nPlease go to the Dashboard and click the "Edit" button (✎) to modify that record.`);
                        return; // Stop submission
                    }
                } catch (err) {
                    console.error("Failed to check duplicates", err);
                    // If we can't check, we continue and let backend handle it
                }
            }
            // ===========================================

            document.getElementById('loading').style.display = 'flex';

            // Prepare Data Object
            const data = {
                student: student,
                term: term,
                year: parseInt(year),
                expense_date: document.getElementById("expense_date").value,
                notes: document.getElementById("notes").value.trim(),
                // Initialize old fields for backward compatibility
                tuition: 0,
                food: 0,
                transport: 0,
                materials: 0,
                hygiene: 0,
                other: 0
            };

            // Collect items data
            const itemsData = {};
            let grandTotal = 0;

            categories.forEach(category => {
                const checkbox = document.getElementById(`check-${category}`);
                if (checkbox.checked) {
                    const itemsTable = document.getElementById(`${category}-items`);
                    const rows = itemsTable.querySelectorAll('tr');
                    const categoryItems = [];
                    let categoryTotal = 0;

                    rows.forEach(row => {
                        // FIX: Use correct class names (item-desc, item-qty)
                        const descInput = row.querySelector('.item-desc');
                        const qtyInput = row.querySelector('.item-qty');
                        const priceInput = row.querySelector('.item-price');

                        const description = descInput ? descInput.value.trim() : '';
                        const quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                        const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        const total = quantity * price;

                        if (description && total > 0) {
                            categoryItems.push({
                                description: description,
                                quantity: quantity,
                                price: price,
                                total: total
                            });
                            categoryTotal += total;
                        }
                    });

                    if (categoryItems.length > 0) {
                        itemsData[category] = categoryItems;
                        // Set the old field for backward compatibility (total for the category)
                        data[category] = categoryTotal;
                        grandTotal += categoryTotal;
                    }
                }
            });

            // Add items data as JSON string
            data.items = JSON.stringify(itemsData);

            try {
                // Determine action type
                const actionType = editingId ? "update" : "add";
                const payload = editingId ? { id: editingId, ...data } : data;

                // Try POST method first
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: actionType,
                        data: payload
                    })
                });

                const successMsg = editingId ? "Record Updated Successfully!" : "Record Saved Successfully!";
                showMessage(successMsg, 'success');

                // Redirect after 1.5 seconds
                setTimeout(() => {
                    window.location.href = DASHBOARD_URL;
                }, 1500);

            } catch (err) {
                console.error("Error:", err);

                // Fallback to GET request
                try {
                    const actionType = editingId ? "update" : "add";
                    const payload = editingId ? { id: editingId, ...data } : data;

                    // Create URL with individual parameters
                    const params = new URLSearchParams();
                    params.append('action', actionType);

                    // Append each data field as separate parameter
                    Object.keys(payload).forEach(key => {
                        if (payload[key] !== undefined && payload[key] !== null) {
                            params.append(key, payload[key]);
                        }
                    });

                    const url = `${API_URL}?${params.toString()}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.error) {
                        throw new Error(result.error);
                    }

                    const successMsg = editingId ? "Record Updated Successfully!" : "Record Saved Successfully!";
                    showMessage(successMsg, 'success');

                    setTimeout(() => {
                        window.location.href = DASHBOARD_URL;
                    }, 1500);

                } catch (fallbackError) {
                    console.error("Fallback error:", fallbackError);
                    let errorMsg = fallbackError.message || "Error saving data. Please try again.";
                    
                    if (errorMsg.includes('NetworkError') || errorMsg.includes('Failed to fetch')) {
                        errorMsg = "Network error. Please check your internet connection and try again.";
                    } else if (errorMsg.includes('405')) {
                        errorMsg = "Server configuration error. Please check your Apps Script deployment.";
                    } else if (errorMsg.includes('404')) {
                        errorMsg = "API endpoint not found. Please check your API URL.";
                    }

                    showMessage(errorMsg, 'error');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // --- EDIT MODE ---
        async function checkForEditMode() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if(!id) return;

            editingId = id;
            document.getElementById('pageTitle').textContent = "Edit Expense Record";
            document.getElementById('saveBtn').textContent = "Update Record";
            document.getElementById('loading').style.display = 'flex';

            try {
                // Add timestamp to prevent caching
                const res = await fetch(`${API_URL}?action=read&t=${Date.now()}`);
                const json = await res.json();
                const record = json.data.find(r => r.id == id);

                if(record) populateForm(record);
                else showMessage("Record not found.", "error");

            } catch(err) {
                console.error(err);
                showMessage("Failed to load record.", "error");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function populateForm(r) {
            // Basic fields
            document.getElementById('student').value = r.student || '';
            document.getElementById('term').value = r.term || '';
            document.getElementById('year').value = r.year || '';
            document.getElementById('expense_date').value = r.expense_date || '';
            document.getElementById('notes').value = r.notes || '';

            // Handle Nested Items
            // 'r.items' comes from backend as stringified JSON, but fetch might have parsed it if backend sent correct headers
            // Our backend sends JSON, but sometimes GAS acts weird. Let's be safe.
            let itemsObj = null;
            
            if(typeof r.items === 'string') {
                try { itemsObj = JSON.parse(r.items); } catch(e) {}
            } else if (typeof r.items === 'object') {
                itemsObj = r.items;
            }

            if(itemsObj) {
                categories.forEach(cat => {
                    if(itemsObj[cat] && Array.isArray(itemsObj[cat])) {
                        // Check category
                        document.getElementById(`check-${cat}`).checked = true;
                        toggleCategorySection(cat, true);
                        
                        // Clear defaults
                        document.getElementById(`${cat}-items`).innerHTML = '';

                        // Add rows
                        itemsObj[cat].forEach(item => {
                            const tbody = document.getElementById(`${cat}-items`);
                            const rowId = Date.now() + Math.random().toString(16).slice(2);
                            const tr = document.createElement('tr');
                            tr.dataset.id = rowId;
                            
                            tr.innerHTML = `
                                <td><input type="text" class="item-input item-desc" value="${item.description || ''}"></td>
                                <td><input type="number" class="item-input item-qty" value="${item.quantity || 1}" oninput="calculateItemTotal(this)"></td>
                                <td><input type="number" class="item-input item-price" value="${item.price || 0}" oninput="calculateItemTotal(this)"></td>
                                <td style="text-align:center;"><button type="button" class="btn-remove" onclick="removeItemRow('${cat}', '${rowId}')">×</button></td>
                            `;
                            tbody.appendChild(tr);
                            calculateItemTotal(tr.querySelector('.item-price')); // Recalc total
                        });
                    }
                });
            }
            updateGrandTotal();
        }

        function goBack() {
            if(confirm("Cancel? Unsaved changes will be lost.")) window.location.href = DASHBOARD_URL;
        }

        function setupEventListeners() {
            // Add Enter key navigation if needed
        }
    </script>
</body>
</html>
