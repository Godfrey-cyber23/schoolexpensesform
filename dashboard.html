<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Expenses Dashboard</title>
  <style>
    :root {
      --primary: #4a90e2;
      --dark: #2c3e50;
      --light: #f4f6f9;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f1c40f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--light);
      margin: 0;
      padding: 12px;
      font-size: 14px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 8px;
    }

    /* Header - Compact for Mobile */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      flex-wrap: nowrap;
    }

    .header h1 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
      max-width: 50%;
    }

    .actions-bar {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      justify-content: flex-end;
      align-items: center;
      flex-shrink: 1;
      min-width: 0;
    }

    .btn {
      padding: 8px 10px;
      border: none;
      border-radius: 5px;
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
      height: 36px;
      min-width: min-content;
    }

    .btn-add {
      background-color: var(--primary);
      color: white;
      padding: 8px 12px;
    }

    .btn-export {
      background-color: var(--dark);
      color: white;
    }

    .btn-export-term {
      background-color: white;
      border: 1px solid var(--dark);
      color: var(--dark);
      padding: 8px 8px;
      font-size: 0.75rem;
      max-width: 100px;
    }

    /* Icon-only buttons on very small screens */
    @media (max-width: 360px) {
      .btn-text {
        display: none;
      }

      .btn-icon {
        display: inline-block !important;
        font-size: 1rem;
      }

      .btn-add {
        padding: 8px;
        min-width: 36px;
      }

      .btn-export {
        padding: 8px;
        min-width: 36px;
      }

      .btn-export-term {
        max-width: 70px;
      }
    }

    .btn-icon {
      display: none;
      margin: 0;
    }

    /* Stats Cards - Compact */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    @media (max-width: 480px) {
      .stats-grid {
        gap: 6px;
      }
    }

    .stat-card {
      background: white;
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-left: 3px solid var(--primary);
      min-width: 0;
      overflow: hidden;
    }

    .stat-card h3 {
      margin: 0 0 4px;
      font-size: 0.7rem;
      color: #95a5a6;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stat-card .value {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--dark);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Compact Toolbar */
    .toolbar {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
      gap: 8px;
    }

    input[type="text"] {
      width: 100%;
      padding: 9px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.85rem;
      min-width: 0;
      height: 36px;
    }

    /* Filter Controls */
    .filter-container {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .filter-header h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filter-toggle {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      color: var(--primary);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 480px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-group label {
      font-size: 0.75rem;
      color: #666;
      font-weight: 600;
    }

    .filter-group select {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.85rem;
      background-color: white;
      cursor: pointer;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }

    .btn-clear {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      color: #666;
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .btn-apply {
      background-color: var(--primary);
      color: white;
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    /* Table Container - Compact */
    .table-wrapper {
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
      position: relative;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 15px;
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    @media (max-width: 768px) {
      table {
        min-width: 700px;
      }
    }

    th,
    td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 0.8rem;
      vertical-align: middle;
    }

    th {
      background-color: #f8f9fa;
      color: var(--dark);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    /* Clickable Row */
    tbody tr {
      cursor: pointer;
      transition: background 0.1s;
    }

    tbody tr:hover {
      background-color: #f0f8ff;
    }

    /* Number columns alignment */
    .number-col {
      text-align: right;
      font-family: 'SF Mono', 'Courier New', monospace;
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
    }

    .total-col {
      font-weight: bold;
      color: var(--dark);
      text-align: right;
      font-family: 'SF Mono', 'Courier New', monospace;
      white-space: nowrap;
    }

    /* Compact Action Buttons */
    .action-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .action-btn {
      padding: 4px 6px;
      border-radius: 3px;
      text-decoration: none;
      font-size: 0.7rem;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 24px;
      min-width: 40px;
    }

    .btn-edit {
      background-color: #f39c12;
      color: white;
    }

    .btn-del {
      background-color: var(--danger);
      color: white;
    }

    .btn-view {
      background-color: var(--primary);
      color: white;
    }

    /* Compact Flag Icon */
    .flag-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .flagged-true {
      color: var(--warning);
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
    }

    .flagged-false {
      color: #ccc;
    }

    /* Column abbreviations for mobile */
    @media (max-width: 768px) {
      th:nth-child(6)::after {
        content: " (T)";
        font-size: 0.6rem;
        opacity: 0.7;
      }

      th:nth-child(7)::after {
        content: " (F)";
        font-size: 0.6rem;
        opacity: 0.7;
      }

      th:nth-child(8)::after {
        content: " (Tr)";
        font-size: 0.6rem;
        opacity: 0.7;
      }

      th:nth-child(9)::after {
        content: " (M)";
        font-size: 0.6rem;
        opacity: 0.7;
      }

      th:nth-child(10)::after {
        content: " (H)";
        font-size: 0.6rem;
        opacity: 0.7;
      }

      th:nth-child(11)::after {
        content: " (O)";
        font-size: 0.6rem;
        opacity: 0.7;
      }
    }

    /* Modal adjustments for mobile */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 15px;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 400px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      line-height: 1;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Footer note for mobile table scrolling */
    .scroll-hint {
      text-align: center;
      padding: 8px;
      color: #666;
      font-size: 0.75rem;
      display: none;
    }

    @media (max-width: 768px) {
      .scroll-hint {
        display: block;
      }
    }

    /* Very small screen adjustments */
    @media (max-width: 320px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 0 4px;
      }

      .header {
        gap: 6px;
      }

      .header h1 {
        font-size: 1.1rem;
      }

      .btn {
        padding: 6px 8px;
        height: 32px;
        font-size: 0.75rem;
      }

      .stat-card {
        padding: 8px 10px;
      }

      .stat-card .value {
        font-size: 1.1rem;
      }

      th,
      td {
        padding: 6px 4px;
        font-size: 0.75rem;
      }
    }

    /* Loading and Empty States */
    #loading {
      text-align: center;
      padding: 30px 20px;
      color: #666;
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 30px 15px;
      color: #666;
      font-size: 0.9rem;
    }

    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--dark);
      font-size: 1rem;
    }

    /* Print Styles */
    @media print {
      body * {
        visibility: hidden;
      }

      .modal-content,
      .modal-content * {
        visibility: visible;
      }

      .modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 15px;
        box-shadow: none;
      }

      .modal-close,
      .modal-footer {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="header">
      <h1>üè´ AFCZ  Student Expense Tracking</h1>
      <div class="actions-bar">
        <select id="exportSelect" class="btn btn-export-term">
          <option value="all">All</option>
          <option value="Term 1">Term 1</option>
          <option value="Term 2">Term 2</option>
          <option value="Term 3">Term 3</option>
        </select>
        <button class="btn btn-export" onclick="exportData()" title="Download Excel">
          <span class="btn-text">Download</span>
          <span class="btn-icon">üì•</span>
        </button>
        <a href="index.html" class="btn btn-add" title="Add New Record">
          <span class="btn-text">Add Record</span>
          <span class="btn-icon">+</span>
        </a>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Spent</h3>
        <div class="value" id="grandTotalDisplay">0.00</div>
      </div>
      <div class="stat-card">
        <h3>Records</h3>
        <div class="value" id="recordCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Flagged</h3>
        <div class="value" id="flaggedCount">0</div>
      </div>
    </div>

    <div class="toolbar">
      <input type="text" id="searchInput" placeholder="üîç Search by student, term, or notes..." onkeyup="filterTable()">
    </div>

    <!-- Filter Controls -->
    <div class="filter-container">
      <div class="filter-header" onclick="toggleFilters()">
        <h3>‚öôÔ∏è Filters</h3>
        <button class="filter-toggle" id="filterToggle">‚ñº</button>
      </div>
      <div class="filters-grid" id="filtersGrid" style="display: none;">
        <div class="filter-group">
          <label for="filterStudent">Student</label>
          <select id="filterStudent" onchange="applyFilters()">
            <option value="">All Students</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterTerm">Term</label>
          <select id="filterTerm" onchange="applyFilters()">
            <option value="">All Terms</option>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterYear">Year</label>
          <select id="filterYear" onchange="applyFilters()">
            <option value="">All Years</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterFlagged">Flag Status</label>
          <select id="filterFlagged" onchange="applyFilters()">
            <option value="">All</option>
            <option value="flagged">Flagged Only</option>
            <option value="not-flagged">Not Flagged</option>
          </select>
        </div>
      </div>
      <div class="filter-actions" id="filterActions" style="display: none;">
        <button class="btn-clear" onclick="clearFilters()">Clear Filters</button>
        <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <div class="scroll-hint">
      ‚Üê Scroll to see all columns ‚Üí
    </div>

    <div class="table-wrapper">
      <table id="expenseTable">
        <thead>
          <tr>
            <th width="50">Flag</th>
            <th width="120">Student</th>
            <th width="80">Date</th>
            <th width="70">Term</th>
            <th width="70">Year</th>
            <th width="80" class="number-col">Tuition</th>
            <th width="80" class="number-col">Food</th>
            <th width="80" class="number-col">Transp</th>
            <th width="80" class="number-col">Mat</th>
            <th width="80" class="number-col">Hyg</th>
            <th width="80" class="number-col">Other</th>
            <th width="90" class="total-col">Total</th>
            <th width="120">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="loading">Loading...</div>
    </div>

  </div>

  <!-- View/Receipt Modal -->
  <div id="viewModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>

      <div class="receipt-header">
        <h2 style="font-size: 1.3rem; margin: 0 0 5px 0;">Payment Receipt</h2>
        <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">School Expenses</p>
        <p id="receiptDate" style="font-size: 0.8rem; color: #999; margin: 0;"></p>
      </div>

      <div style="margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
          <strong>Student:</strong> <span id="modalStudent"></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
          <strong>Term:</strong> <span id="modalTerm"></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
          <strong>Year:</strong> <span id="modalYear"></span>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">

      <div id="modalBreakdown"></div>

      <div
        style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; margin-top: 15px; border-top: 2px dashed #ccc; padding-top: 10px;">
        <span>Total:</span> <span id="modalTotal"></span>
      </div>

      <div style="margin-top: 15px; font-size: 0.8rem; color: #777;">
        <div style="margin-bottom: 5px;"><strong>Notes:</strong> <span id="modalNotes">None</span></div>
        <div><strong>ID:</strong> <span id="modalId"></span></div>
      </div>

      <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-export" onclick="window.print()"
          style="padding: 8px 12px; font-size: 0.8rem;">Print</button>
        <button class="btn" onclick="closeModal()"
          style="margin-left: 0; background-color: #eee; padding: 8px 12px; font-size: 0.8rem;">Close</button>
      </div>
    </div>
  </div>

 <script>
const API = "https://script.google.com/macros/s/AKfycbzEEeuwtZm-qGOmKLza3IfdVieYurAH14xgp3Q0lUPwUpvyz2rIHUlkC48sCc2FUK9i/exec";
let allData = [];
let filteredData = [];

// Filter state
let currentFilters = {
  student: '',
  term: '',
  year: '',
  flagged: '',
  search: ''
};

window.onload = function() {
  loadData();
  // Set current year in year filter
  const currentYear = new Date().getFullYear();
  const yearSelect = document.getElementById('filterYear');
  // Add recent years
  for (let i = currentYear + 1; i >= currentYear - 5; i--) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    yearSelect.appendChild(option);
  }
};

function loadData() {
  document.getElementById('loading').style.display = 'block';
  
  const url = `${API}?action=read&t=${new Date().getTime()}`;
  
  fetch(url)
    .then(res => res.text())
    .then(text => {
      // Extract JSON from response (remove any appended headers)
      const jsonStart = text.indexOf('{');
      const jsonEnd = text.lastIndexOf('}') + 1;
      
      if (jsonStart !== -1 && jsonEnd > jsonStart) {
        const jsonText = text.substring(jsonStart, jsonEnd);
        const data = JSON.parse(jsonText);
        allData = data.data || [];
        filteredData = [...allData];
        
        // Populate student filter dropdown
        populateStudentFilter();
        
        renderTable(filteredData);
        updateStats(filteredData);
      } else {
        throw new Error('No valid JSON found in response');
      }
      document.getElementById('loading').style.display = 'none';
    })
    .catch(err => {
      console.error('Error:', err);
      document.getElementById('loading').innerHTML = `
        <div class="empty-state">
          <h3>Error Loading Data</h3>
          <p>${err.message}</p>
          <button class="btn btn-add" onclick="loadData()">Retry</button>
        </div>
      `;
    });
}

function populateStudentFilter() {
  const studentSelect = document.getElementById('filterStudent');
  const students = [...new Set(allData.map(item => item.student))].sort();
  
  // Clear existing options except first
  while (studentSelect.options.length > 1) {
    studentSelect.remove(1);
  }
  
  // Add student options
  students.forEach(student => {
    const option = document.createElement('option');
    option.value = student;
    option.textContent = student;
    studentSelect.appendChild(option);
  });
}

function toggleFilters() {
  const filtersGrid = document.getElementById('filtersGrid');
  const filterActions = document.getElementById('filterActions');
  const filterToggle = document.getElementById('filterToggle');
  
  if (filtersGrid.style.display === 'none') {
    filtersGrid.style.display = 'grid';
    filterActions.style.display = 'flex';
    filterToggle.textContent = '‚ñ≤';
  } else {
    filtersGrid.style.display = 'none';
    filterActions.style.display = 'none';
    filterToggle.textContent = '‚ñº';
  }
}

function applyFilters() {
  // Get filter values
  currentFilters.student = document.getElementById('filterStudent').value;
  currentFilters.term = document.getElementById('filterTerm').value;
  currentFilters.year = document.getElementById('filterYear').value;
  currentFilters.flagged = document.getElementById('filterFlagged').value;
  currentFilters.search = document.getElementById('searchInput').value.toLowerCase().trim();
  
  // Apply filters
  filteredData = allData.filter(item => {
    // Student filter
    if (currentFilters.student && item.student !== currentFilters.student) {
      return false;
    }
    
    // Term filter
    if (currentFilters.term && item.term !== currentFilters.term) {
      return false;
    }
    
    // Year filter
    if (currentFilters.year && item.year != currentFilters.year) {
      return false;
    }
    
    // Flagged filter
    const isFlagged = item.flagged === true || item.flagged === 'true';
    if (currentFilters.flagged === 'flagged' && !isFlagged) {
      return false;
    }
    if (currentFilters.flagged === 'not-flagged' && isFlagged) {
      return false;
    }
    
    // Search filter
    if (currentFilters.search) {
      const searchMatch = 
        item.student.toLowerCase().includes(currentFilters.search) ||
        item.term.toLowerCase().includes(currentFilters.search) ||
        (item.notes && item.notes.toLowerCase().includes(currentFilters.search)) ||
        item.year.toString().includes(currentFilters.search);
      
      if (!searchMatch) {
        return false;
      }
    }
    
    return true;
  });
  
  renderTable(filteredData);
  updateStats(filteredData);
  
  // Update search input to match filter state
  document.getElementById('searchInput').value = currentFilters.search;
}

function clearFilters() {
  // Reset filter inputs
  document.getElementById('filterStudent').value = '';
  document.getElementById('filterTerm').value = '';
  document.getElementById('filterYear').value = '';
  document.getElementById('filterFlagged').value = '';
  document.getElementById('searchInput').value = '';
  
  // Reset filter state
  currentFilters = {
    student: '',
    term: '',
    year: '',
    flagged: '',
    search: ''
  };
  
  // Show all data
  filteredData = [...allData];
  renderTable(filteredData);
  updateStats(filteredData);
}

function filterTable() {
  // Update search filter and apply all filters
  currentFilters.search = document.getElementById('searchInput').value.toLowerCase().trim();
  applyFilters();
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  
  if (!data.length) { 
    tbody.innerHTML = `
      <tr>
        <td colspan="13" style="text-align:center; padding: 30px;">
          <div class="empty-state">
            <h3>No Records Found</h3>
            <p>Try adjusting your filters or search</p>
            <button class="btn btn-add" onclick="clearFilters()" style="padding: 6px 10px; font-size: 0.8rem;">Clear Filters</button>
          </div>
        </td>
      </tr>`; 
    return; 
  }

  // Sort by date (newest first)
  data.sort((a, b) => new Date(b.expense_date) - new Date(a.expense_date));

  data.forEach(r => {
    const total = (Number(r.tuition)||0)+(Number(r.food)||0)+(Number(r.transport)||0)+(Number(r.materials)||0)+(Number(r.hygiene)||0)+(Number(r.other)||0);
    const isFlagged = r.flagged === true || r.flagged === 'true';
    const flagClass = isFlagged ? 'flagged-true' : 'flagged-false';
    const flagIcon = isFlagged ? '‚òÖ' : '‚òÜ';

    const row = document.createElement('tr');
    row.dataset.id = r.id;
    
    row.innerHTML = `
      <td>
        <button class="flag-btn ${flagClass}" 
                title="${isFlagged ? 'Unflag' : 'Flag'}">
          ${flagIcon}
        </button>
      </td>
      <td style="font-weight:600;">${escapeHtml(r.student)}</td>
      <td>${new Date(r.expense_date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</td>
      <td>${escapeHtml(r.term)}</td>
      <td>${r.year}</td>
      <td class="number-col">${formatNum(r.tuition)}</td>
      <td class="number-col">${formatNum(r.food)}</td>
      <td class="number-col">${formatNum(r.transport)}</td>
      <td class="number-col">${formatNum(r.materials)}</td>
      <td class="number-col">${formatNum(r.hygiene)}</td>
      <td class="number-col">${formatNum(r.other)}</td>
      <td class="total-col">${formatNum(total)}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" title="View">View</button>
          <a href="index.html?id=${encodeURIComponent(r.id)}" class="action-btn btn-edit" title="Edit">Edit</a>
          <button class="action-btn btn-del" title="Delete">Del</button>
        </div>
      </td>
    `;
    
    // Store data on the row for event handlers
    row.dataset.record = JSON.stringify(r);
    
    // Add click event for the whole row
    row.addEventListener('click', (e) => {
      if (!e.target.closest('button') && !e.target.closest('a')) {
        openModal(r.id);
      }
    });
    
    tbody.appendChild(row);
  });
  
  // Add event listeners after table is rendered
  attachTableEventListeners();
}

function attachTableEventListeners() {
  // Flag buttons
  document.querySelectorAll('.flag-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const row = this.closest('tr');
      const record = JSON.parse(row.dataset.record);
      const currentFlagged = record.flagged === true || record.flagged === 'true';
      toggleFlag(record.id, currentFlagged);
    });
  });
  
  // View buttons
  document.querySelectorAll('.btn-view').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const row = this.closest('tr');
      const record = JSON.parse(row.dataset.record);
      openModal(record.id);
    });
  });
  
  // Delete buttons
  document.querySelectorAll('.btn-del').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const row = this.closest('tr');
      const record = JSON.parse(row.dataset.record);
      del(record.id);
    });
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function updateStats(data) {
  let grandTotal = 0, flaggedCount = 0;
  data.forEach(r => {
    grandTotal += (Number(r.tuition)||0)+(Number(r.food)||0)+(Number(r.transport)||0)+(Number(r.materials)||0)+(Number(r.hygiene)||0)+(Number(r.other)||0);
    if(r.flagged === true || r.flagged === 'true') flaggedCount++;
  });
  document.getElementById('grandTotalDisplay').innerText = formatNum(grandTotal);
  document.getElementById('recordCount').innerText = data.length;
  document.getElementById('flaggedCount').innerText = flaggedCount;
}

function formatNum(num) { 
  const n = Number(num||0);
  return n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function del(id) {
  if(confirm("Delete this record?")) {
    document.getElementById('loading').style.display = 'block';
    
    // Use GET request with action=delete
    const url = `${API}?action=delete&id=${encodeURIComponent(id)}&t=${new Date().getTime()}`;
    
    fetch(url)
      .then(res => res.text())
      .then(text => {
        const jsonStart = text.indexOf('{');
        const jsonEnd = text.lastIndexOf('}') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          const jsonText = text.substring(jsonStart, jsonEnd);
          const result = JSON.parse(jsonText);
          
          if (result.success) {
            loadData();
          } else {
            alert("Delete failed: " + (result.message || 'Unknown error'));
            document.getElementById('loading').style.display = 'none';
          }
        } else {
          throw new Error('Invalid response from server');
        }
      })
      .catch(err => {
        console.error(err);
        alert("Delete failed. Try again.");
        document.getElementById('loading').style.display = 'none';
      });
  }
}

function toggleFlag(id, currentStatus) {
  console.log('Toggling flag for id:', id, 'currentStatus:', currentStatus);
  
  document.getElementById('loading').style.display = 'block';
  
  // Try using GET request first (simpler for debugging)
  const url = `${API}?action=update&id=${encodeURIComponent(id)}&flagged=${!currentStatus}&t=${new Date().getTime()}`;
  
  console.log('GET URL:', url);
  
  fetch(url)
    .then(response => response.text())
    .then(text => {
      console.log('Response text:', text);
      
      const jsonStart = text.indexOf('{');
      const jsonEnd = text.lastIndexOf('}') + 1;
      
      if (jsonStart !== -1 && jsonEnd > jsonStart) {
        const jsonText = text.substring(jsonStart, jsonEnd);
        console.log('JSON text to parse:', jsonText);
        
        try {
          const result = JSON.parse(jsonText);
          console.log('Parsed result:', result);
          
          if (result.success) {
            // Reload data to show updated flag
            loadData();
          } else {
            alert("Failed to update flag: " + (result.message || 'Unknown error'));
            document.getElementById('loading').style.display = 'none';
          }
        } catch (parseError) {
          console.error('Parse error:', parseError);
          alert("Failed to parse server response");
          document.getElementById('loading').style.display = 'none';
        }
      } else {
        console.error('No JSON found in response');
        throw new Error('Invalid response from server');
      }
    })
    .catch(err => {
      console.error('Fetch error:', err);
      alert("Failed to update flag. Check console for details.");
      document.getElementById('loading').style.display = 'none';
    });
}

function exportData() {
  const filterTerm = document.getElementById('exportSelect').value;
  let dataToExport = filteredData; // Use filtered data for export
  
  if (filterTerm !== 'all') {
    dataToExport = dataToExport.filter(i => i.term === filterTerm);
  }

  if (dataToExport.length === 0) {
    alert("No data to export!");
    return;
  }

  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Student,Date,Term,Year,Tuition,Food,Transport,Materials,Hygiene,Other,Total,Notes\n";

  dataToExport.forEach(r => {
    const total = (Number(r.tuition)||0)+(Number(r.food)||0)+(Number(r.transport)||0)+(Number(r.materials)||0)+(Number(r.hygiene)||0)+(Number(r.other)||0);
    const row = [
      `"${r.student}"`,
      r.expense_date,
      r.term,
      r.year,
      r.tuition,
      r.food,
      r.transport,
      r.materials,
      r.hygiene,
      r.other,
      total,
      `"${(r.notes || '').replace(/"/g, '""')}"`
    ];
    csvContent += row.join(",") + "\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `expenses_${filterTerm}_filtered.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function openModal(id) {
  const r = filteredData.find(x => x.id == id);
  if(!r) {
    console.error('Record not found with id:', id);
    return;
  }

  const total = (Number(r.tuition)||0)+(Number(r.food)||0)+(Number(r.transport)||0)+(Number(r.materials)||0)+(Number(r.hygiene)||0)+(Number(r.other)||0);

  document.getElementById('modalStudent').innerText = r.student;
  document.getElementById('modalTerm').innerText = r.term;
  document.getElementById('modalYear').innerText = r.year;
  document.getElementById('receiptDate').innerText = new Date(r.expense_date).toLocaleDateString();
  document.getElementById('modalTotal').innerText = formatNum(total);
  document.getElementById('modalNotes').innerText = r.notes || "No notes";
  document.getElementById('modalId').innerText = r.id;

  let breakdownHTML = "";
  const categories = [
    {k:'tuition', l:'Tuition'}, 
    {k:'food', l:'Food'}, 
    {k:'transport', l:'Transport'}, 
    {k:'materials', l:'Materials'}, 
    {k:'hygiene', l:'Hygiene'}, 
    {k:'other', l:'Other'}
  ];

  categories.forEach(cat => {
    const value = Number(r[cat.k]) || 0;
    if(value > 0) {
      breakdownHTML += `
        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem;">
          <span>${cat.l}:</span>
          <span>${formatNum(value)}</span>
        </div>`;
    }
  });
  
  document.getElementById('modalBreakdown').innerHTML = breakdownHTML;
  document.getElementById('viewModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('viewModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

window.onclick = function(event) {
  const modal = document.getElementById('viewModal');
  if (event.target == modal) closeModal();
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') closeModal();
});
</script>
</body>

</html>